# MQTT
## 1. 概述
MQTT 是一个客户端架构的发布/订阅模式的消息传输协议。设计思想是轻巧、开放、简单、规范、易于实现。这些特点是它对很多场景来说都是很好的选择，特别是对于受限的环境如机器与机器的通信(M2M)以及物联网环境(IoT)
## 2. 协议原理
### MQTT协议实现方式
     发布消息        订阅消息
`发布者` ------>   `代理`  <-----------> 订阅者<br>

                   推送消息
### 网络传输与应用消息
MQTT会构建底层网络传输：它将建立客户端到服务器的连接，提供两者之间的一个有序的、无损的、基于字节流的双向传输。

#### 客户端
客户端就是使用MQTT协议的应用程序或设备。它可以
- 发布应用消息给其它相关的客户端。
- 订阅以请求接受相关的应用消息。
- 取消订阅以移除接受应用消息的请求。
- 从服务端断开连接。
#### 服务端 Server
一个程序或设备，作为发送消息的客户端和请求订阅的客户端之间的中介。服务端
- 接受来自客户端的网络连接。
- 接受客户端发布的应用消息。
- 处理客户端的订阅和取消订阅请求。
- 转发应用消息给符合条件的已订阅客户端。
#### 订阅 Subscription
订阅包含一个主题过滤器（Topic Filter）和一个最大的服务质量（QoS）等级。订阅与单个会话（Session）关联。会话可以包含多于一个的订阅。会话的每个订阅都有一个不同的主题过滤器。
#### 主题名 Topic Name
附加在应用消息上的一个标签，服务端已知且与订阅匹配。服务端发送应用消息的一个副本给每一个匹配的客户端订阅。
#### 主题过滤器 Topic Filter
订阅中包含的一个表达式，用于表示相关的一个或多个主题。主题过滤器可以使用通配符。
#### 会话 Session
客户端和服务端之间的状态交互。一些会话持续时长与网络连接一样，另一些可以在客户端和服务端的多个连续网络连接间扩展。
#### 负载Payload
消息订阅者所具体接收的内容。
### 方法
一个MQTT数据包由：固定头（Fixed header）、可变头（Variable header）、消息体（payload）三部分构成。<br>
固定头（Fixed header）。存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识。<br>
可变头（Variable header）。存在于部分MQTT数据包中，数据包类型决定了可变头是否存在及其具体内容。<br>
消息体（Payload）。存在于部分MQTT数据包中，表示客户端收到的具体内容。<br>
**固定头**： 0~3个bit 存放不同类型的MQTT数据包的具体表示 4~7存放MQTT数据包类型。 其他存放剩余长度。
**剩余长度**: 固定头的第二字节用来保存变长头部和消息体的总大小的，但不是直接保存的。这一字节是可以扩展，其保存机制，前7位用于保存长度，后一部用做标识。当最后一位为1时，表示长度不足，需要使用二个字节继续保存。例如：计算出后面的大小为0
**MQTT可变头**:MQTT数据包中包含一个可变头，它驻位于固定的头和负载之间。可变头的内容因数据包类型而不同，较常的应用是作为包的标识。
**Payload消息体**：Payload消息体位MQTT数据包的第三部分，包含CONNECT、SUBSCRIBE、SUBACK、UNSUBSCRIBE四种类型的消息：

- CONNECT，消息体内容主要是：客户端的ClientID、订阅的Topic、Message以及用户名和密码。
- SUBSCRIBE，消息体内容是一系列的要订阅的主题以及QoS。
- SUBACK，消息体内容是服务器对于SUBSCRIBE所申请的主题及QoS进行确认和回复。
- UNSUBSCRIBE，消息体内容是要订阅的主题。